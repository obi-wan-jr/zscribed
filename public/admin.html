<!doctype html>
<html lang="en" class="h-full">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>dScribe â€¢ Admin</title>
	<link rel="stylesheet" href="/styles.build.v2.css?v=1756358000000" />
</head>
<body class="h-full bg-[#0b1020] text-slate-200">
	<div class="min-h-full">
		<nav class="px-4 py-3 border-b border-slate-700 bg-[#0b1020]/90 sticky top-0 z-10">
			<div class="max-w-6xl mx-auto flex items-center justify-between">
				<!-- Left: dScribe Logo -->
				<a href="/" class="text-xl font-semibold text-indigo-300">dScribe</a>
				
				<!-- Center: Navigation Menu -->
				<div class="flex-1 flex justify-center space-x-6 nav-center">
					<a href="/tts.html" class="nav-link">Text-to-Speech</a>
					<a href="/bible.html" class="nav-link">Bible Transcription</a>
					<a href="/admin.html" class="nav-link active">Admin</a>
					<a href="/settings.html" class="nav-link">Settings</a>
				</div>
				
				<!-- Right: User Info and Logout -->
				<div id="userSection" class="flex items-center space-x-4">
					<a href="/login.html" id="loginLogoutLink" class="nav-link">Login</a>
				</div>
			</div>
		</nav>
		
		<main class="max-w-6xl mx-auto p-4 space-y-6">
			<!-- System Status -->
			<section class="bg-[#121733] border border-slate-700 rounded-lg p-4">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-medium text-indigo-200">System Status</h2>
					<button onclick="refreshStatus()" class="px-3 py-2 rounded bg-slate-600 hover:bg-slate-500 transition-colors">
						Refresh
					</button>
				</div>
				<div id="systemStatus" class="grid grid-cols-2 gap-4 text-sm">
					<div class="flex justify-between">
						<span class="text-slate-300">Server Status:</span>
						<span id="serverStatus" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span class="text-slate-300">TTS Service:</span>
						<span id="ttsStatus" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span class="text-slate-300">Active Jobs:</span>
						<span id="activeJobs" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span class="text-slate-300">Queue Length:</span>
						<span id="queueLength" class="text-yellow-400">Checking...</span>
					</div>
				</div>
			</section>

			<!-- Cache Management -->
			<section class="bg-[#121733] border border-slate-700 rounded-lg p-4">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-medium text-indigo-200">Cache Management</h2>
					<button onclick="refreshCacheStatus()" class="px-3 py-2 rounded bg-slate-600 hover:bg-slate-500 transition-colors">
						Refresh
					</button>
				</div>
				<div id="cacheStatus" class="grid grid-cols-2 gap-4 text-sm mb-4">
					<div class="flex justify-between">
						<span class="text-slate-300">Cache Buster:</span>
						<span id="cacheBuster" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span class="text-slate-300">App Version:</span>
						<span id="appVersion" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span class="text-slate-300">Last Updated:</span>
						<span id="lastUpdated" class="text-yellow-400">Checking...</span>
					</div>
				</div>
				<button onclick="purgeCache()" class="w-full bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors">
					Purge Cloudflare Cache
				</button>
			</section>

			<!-- Voice Models -->
			<section class="bg-[#121733] border border-slate-700 rounded-lg p-4">
				<h2 class="text-lg font-medium text-indigo-200 mb-4">Voice Models</h2>
				<div class="space-y-4">
					<div class="flex space-x-2">
						<input type="text" id="newVoiceId" placeholder="Voice ID" class="flex-1 bg-[#0b1020] border border-slate-600 rounded px-3 py-2 text-white">
						<input type="text" id="newVoiceName" placeholder="Voice Name" class="flex-1 bg-[#0b1020] border border-slate-600 rounded px-3 py-2 text-white">
						<button onclick="addVoiceModel()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors">
							Add
						</button>
					</div>
					<div id="voiceModelsList" class="space-y-2">
						<div class="text-slate-400">Loading voice models...</div>
					</div>
				</div>
			</section>

			<!-- System Logs -->
			<section class="bg-[#121733] border border-slate-700 rounded-lg p-4">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-medium text-indigo-200">Recent Logs</h2>
					<button onclick="refreshLogs()" class="px-3 py-2 rounded bg-slate-600 hover:bg-slate-500 transition-colors">
						Refresh
					</button>
				</div>
				<div id="systemLogs" class="space-y-2 max-h-64 overflow-y-auto text-sm">
					<div class="text-slate-400">Loading logs...</div>
				</div>
			</section>
		</main>
	</div>

	<script type="module">
		import { authenticatedFetch, checkAuth, logout, getActiveUser, updateNavigation } from '/common.js';
		
		// Make functions globally available
		window.authenticatedFetch = authenticatedFetch;
		window.checkAuth = checkAuth;
		window.logout = logout;
		
		// Check authentication on page load
		document.addEventListener('DOMContentLoaded', async () => {
			if (!await checkAuth()) {
				window.location.href = '/login.html';
				return;
			}
			
			// Update navigation with user info
			await updateNavigation();
			
			// Fallback navigation update in case the module function fails
			setTimeout(async () => {
				try {
					// Try to get user directly and update navigation
					const userRes = await fetch('/api/auth/current-user', {
						credentials: 'include',
						headers: { 'Accept': 'application/json' }
					});
					if (userRes.ok) {
						const userData = await userRes.json();
						const userSection = document.getElementById('userSection');
						if (userSection && userData.user) {
							userSection.innerHTML = '';
							const container = document.createElement('div');
							container.className = 'flex items-center space-x-4';
							
							const greetingText = document.createElement('span');
							greetingText.className = 'text-gray-300';
							greetingText.textContent = `Hi, ${userData.user}!`;
							
							const logoutBtn = document.createElement('button');
							logoutBtn.className = 'text-red-400 hover:text-red-300 transition-colors';
							logoutBtn.textContent = 'Logout';
							logoutBtn.onclick = () => {
								fetch('/api/auth/logout', { method: 'POST' })
									.then(() => window.location.href = '/login.html');
							};
							
							container.appendChild(greetingText);
							container.appendChild(logoutBtn);
							userSection.appendChild(container);
							console.log('Fallback navigation update successful');
						}
					}
				} catch (error) {
					console.warn('Fallback navigation update failed:', error);
				}
			}, 2000);
			
			// Load initial data
			refreshStatus();
			refreshCacheStatus();
			refreshVoiceModels();
			refreshLogs();
			
			// Set up periodic refresh
			setInterval(refreshStatus, 30000); // Every 30 seconds
			setInterval(refreshCacheStatus, 60000); // Every minute
		});

		async function refreshStatus() {
			try {
				const res = await authenticatedFetch('/api/health');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('serverStatus').textContent = 'Online';
					document.getElementById('serverStatus').className = 'text-green-400';
					document.getElementById('ttsStatus').textContent = data.ttsService ? 'Available' : 'Unavailable';
					document.getElementById('ttsStatus').className = data.ttsService ? 'text-green-400' : 'text-red-400';
				} else {
					document.getElementById('serverStatus').textContent = 'Offline';
					document.getElementById('serverStatus').className = 'text-red-400';
				}
			} catch (error) {
				document.getElementById('serverStatus').textContent = 'Error';
				document.getElementById('serverStatus').className = 'text-red-400';
			}

			try {
				const res = await authenticatedFetch('/api/queue/status');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('activeJobs').textContent = data.processing;
					document.getElementById('queueLength').textContent = data.pending;
				}
			} catch (error) {
				document.getElementById('activeJobs').textContent = 'Error';
				document.getElementById('queueLength').textContent = 'Error';
			}
		}

		async function refreshCacheStatus() {
			try {
				const res = await authenticatedFetch('/api/cache/status');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('cacheBuster').textContent = data.cacheBuster;
					document.getElementById('appVersion').textContent = data.appVersion;
					document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleString();
				}
			} catch (error) {
				document.getElementById('cacheBuster').textContent = 'Error';
				document.getElementById('appVersion').textContent = 'Error';
				document.getElementById('lastUpdated').textContent = 'Error';
			}
		}

		async function purgeCache() {
			if (!confirm('Are you sure you want to purge the Cloudflare cache? This will force all clients to reload assets.')) {
				return;
			}

			try {
				const res = await authenticatedFetch('/api/cache/purge', {
					method: 'POST'
				});
				
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					alert('Cache purged successfully! New cache buster: ' + data.cacheBuster);
					refreshCacheStatus();
				} else {
					alert('Failed to purge cache');
				}
			} catch (error) {
				alert('Error purging cache: ' + error.message);
			}
		}

		async function refreshVoiceModels() {
			try {
				const res = await authenticatedFetch('/api/models');
				if (!res) return;
				
				if (res.ok) {
					const models = await res.json();
					const container = document.getElementById('voiceModelsList');
					
					if (models.length === 0) {
						container.innerHTML = '<div class="text-slate-400">No voice models configured</div>';
						return;
					}
					
					container.innerHTML = models.map(model => `
						<div class="flex justify-between items-center bg-[#0b1020] p-3 rounded border border-slate-600">
							<div>
								<span class="font-medium">${model.name}</span>
								<span class="text-slate-400 text-sm ml-2">${model.id}</span>
							</div>
							<button onclick="deleteVoiceModel('${model.id}')" class="text-red-400 hover:text-red-300 transition-colors">
								Delete
							</button>
						</div>
					`).join('');
				}
			} catch (error) {
				document.getElementById('voiceModelsList').innerHTML = '<div class="text-red-400">Error loading voice models</div>';
			}
		}

		async function addVoiceModel() {
			const id = document.getElementById('newVoiceId').value.trim();
			const name = document.getElementById('newVoiceName').value.trim();
			
			if (!id || !name) {
				alert('Please enter both Voice ID and Name');
				return;
			}
			
			try {
				const res = await authenticatedFetch('/api/models', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ id, name })
				});
				
				if (!res) return;
				
				if (res.ok) {
					document.getElementById('newVoiceId').value = '';
					document.getElementById('newVoiceName').value = '';
					refreshVoiceModels();
					alert('Voice model added successfully');
				} else {
					const error = await res.json();
					alert('Failed to add voice model: ' + error.error);
				}
			} catch (error) {
				alert('Error adding voice model: ' + error.message);
			}
		}

		async function deleteVoiceModel(id) {
			if (!confirm('Are you sure you want to delete this voice model?')) {
				return;
			}
			
			try {
				const res = await authenticatedFetch(`/api/models/${id}`, {
					method: 'DELETE'
				});
				
				if (!res) return;
				
				if (res.ok) {
					refreshVoiceModels();
					alert('Voice model deleted successfully');
				} else {
					const error = await res.json();
					alert('Failed to delete voice model: ' + error.error);
				}
			} catch (error) {
				alert('Error deleting voice model: ' + error.message);
			}
		}

		async function refreshLogs() {
			try {
				const res = await authenticatedFetch('/api/logs');
				if (!res) return;
				
				if (res.ok) {
					const logs = await res.json();
					const container = document.getElementById('systemLogs');
					
					if (logs.length === 0) {
						container.innerHTML = '<div class="text-slate-400">No recent logs</div>';
						return;
					}
					
					container.innerHTML = logs.map(log => `
						<div class="bg-[#0b1020] p-2 rounded border border-slate-600">
							<div class="flex justify-between text-xs text-slate-400">
								<span>${new Date(log.timestamp).toLocaleString()}</span>
								<span>${log.user || 'system'}</span>
							</div>
							<div class="text-sm mt-1">${log.message}</div>
						</div>
					`).join('');
				}
			} catch (error) {
				document.getElementById('systemLogs').innerHTML = '<div class="text-red-400">Error loading logs</div>';
			}
		}

		// Make functions globally available for onclick handlers
		window.refreshStatus = refreshStatus;
		window.refreshCacheStatus = refreshCacheStatus;
		window.purgeCache = purgeCache;
		window.refreshVoiceModels = refreshVoiceModels;
		window.addVoiceModel = addVoiceModel;
		window.deleteVoiceModel = deleteVoiceModel;
		window.refreshLogs = refreshLogs;
	</script>
</body>
</html>
