<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>dScribe â€¢ Admin</title>
	<link rel="stylesheet" href="/styles.build.v2.css?v=1756358000000" />
</head>
<body class="h-full bg-[#0b1020] text-slate-200">
	<!-- Navigation -->
	<nav class="bg-[#1a1f2e] border-b border-slate-700">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between h-16">
				<!-- Logo -->
				<div class="flex items-center">
					<h1 class="text-xl font-bold text-blue-400">dScribe</h1>
				</div>
				
				<!-- Center Menu -->
				<div class="flex items-center space-x-8">
					<a href="/index.html" class="text-slate-300 hover:text-white transition-colors">Home</a>
					<a href="/bible.html" class="text-slate-300 hover:text-white transition-colors">Bible</a>
					<a href="/tts.html" class="text-slate-300 hover:text-white transition-colors">TTS</a>
					<a href="/admin.html" class="text-blue-400 font-medium">Admin</a>
				</div>
				
				<!-- User Info -->
				<div class="flex items-center space-x-4">
					<span id="userInfo" class="text-slate-300"></span>
					<button onclick="logout()" class="text-slate-400 hover:text-white transition-colors">Logout</button>
				</div>
			</div>
		</div>
	</nav>

	<!-- Main Content -->
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
			<!-- System Status -->
			<div class="bg-[#1a1f2e] rounded-lg p-6 border border-slate-700">
				<h2 class="text-xl font-semibold mb-4">System Status</h2>
				<div id="systemStatus" class="space-y-3">
					<div class="flex justify-between">
						<span>Server Status:</span>
						<span id="serverStatus" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span>TTS Service:</span>
						<span id="ttsStatus" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span>Active Jobs:</span>
						<span id="activeJobs" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span>Queue Length:</span>
						<span id="queueLength" class="text-yellow-400">Checking...</span>
					</div>
				</div>
				<button onclick="refreshStatus()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
					Refresh Status
				</button>
			</div>

			<!-- Cache Management -->
			<div class="bg-[#1a1f2e] rounded-lg p-6 border border-slate-700">
				<h2 class="text-xl font-semibold mb-4">Cache Management</h2>
				<div id="cacheStatus" class="space-y-3 mb-4">
					<div class="flex justify-between">
						<span>Cache Buster:</span>
						<span id="cacheBuster" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span>App Version:</span>
						<span id="appVersion" class="text-yellow-400">Checking...</span>
					</div>
					<div class="flex justify-between">
						<span>Last Updated:</span>
						<span id="lastUpdated" class="text-yellow-400">Checking...</span>
					</div>
				</div>
				<div class="space-y-2">
					<button onclick="purgeCache()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
						Purge Cloudflare Cache
					</button>
					<button onclick="refreshCacheStatus()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
						Refresh Cache Status
					</button>
				</div>
			</div>

			<!-- Voice Models -->
			<div class="bg-[#1a1f2e] rounded-lg p-6 border border-slate-700">
				<h2 class="text-xl font-semibold mb-4">Voice Models</h2>
				<div class="space-y-4">
					<div class="flex space-x-2">
						<input type="text" id="newVoiceId" placeholder="Voice ID" class="flex-1 bg-[#0b1020] border border-slate-600 rounded px-3 py-2 text-white">
						<input type="text" id="newVoiceName" placeholder="Voice Name" class="flex-1 bg-[#0b1020] border border-slate-600 rounded px-3 py-2 text-white">
						<button onclick="addVoiceModel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
							Add
						</button>
					</div>
					<div id="voiceModelsList" class="space-y-2">
						<div class="text-slate-400">Loading voice models...</div>
					</div>
				</div>
			</div>

			<!-- System Logs -->
			<div class="bg-[#1a1f2e] rounded-lg p-6 border border-slate-700">
				<h2 class="text-xl font-semibold mb-4">Recent Logs</h2>
				<div id="systemLogs" class="space-y-2 max-h-64 overflow-y-auto text-sm">
					<div class="text-slate-400">Loading logs...</div>
				</div>
				<button onclick="refreshLogs()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
					Refresh Logs
				</button>
			</div>
		</div>
	</div>

	<script src="/common.js"></script>
	<script>
		// Check authentication on page load
		document.addEventListener('DOMContentLoaded', async () => {
			if (!await checkAuth()) {
				window.location.href = '/login.html';
				return;
			}
			
			// Load initial data
			refreshStatus();
			refreshCacheStatus();
			refreshVoiceModels();
			refreshLogs();
			
			// Set up periodic refresh
			setInterval(refreshStatus, 30000); // Every 30 seconds
			setInterval(refreshCacheStatus, 60000); // Every minute
		});

		async function refreshStatus() {
			try {
				const res = await authenticatedFetch('/api/health');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('serverStatus').textContent = 'Online';
					document.getElementById('serverStatus').className = 'text-green-400';
					document.getElementById('ttsStatus').textContent = data.ttsService ? 'Available' : 'Unavailable';
					document.getElementById('ttsStatus').className = data.ttsService ? 'text-green-400' : 'text-red-400';
				} else {
					document.getElementById('serverStatus').textContent = 'Offline';
					document.getElementById('serverStatus').className = 'text-red-400';
				}
			} catch (error) {
				document.getElementById('serverStatus').textContent = 'Error';
				document.getElementById('serverStatus').className = 'text-red-400';
			}

			try {
				const res = await authenticatedFetch('/api/queue/status');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('activeJobs').textContent = data.processing;
					document.getElementById('queueLength').textContent = data.pending;
				}
			} catch (error) {
				document.getElementById('activeJobs').textContent = 'Error';
				document.getElementById('queueLength').textContent = 'Error';
			}
		}

		async function refreshCacheStatus() {
			try {
				const res = await authenticatedFetch('/api/cache/status');
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					document.getElementById('cacheBuster').textContent = data.cacheBuster;
					document.getElementById('appVersion').textContent = data.appVersion;
					document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleString();
				}
			} catch (error) {
				document.getElementById('cacheBuster').textContent = 'Error';
				document.getElementById('appVersion').textContent = 'Error';
				document.getElementById('lastUpdated').textContent = 'Error';
			}
		}

		async function purgeCache() {
			if (!confirm('Are you sure you want to purge the Cloudflare cache? This will force all clients to reload assets.')) {
				return;
			}

			try {
				const res = await authenticatedFetch('/api/cache/purge', {
					method: 'POST'
				});
				
				if (!res) return;
				
				if (res.ok) {
					const data = await res.json();
					alert('Cache purged successfully! New cache buster: ' + data.cacheBuster);
					refreshCacheStatus();
				} else {
					alert('Failed to purge cache');
				}
			} catch (error) {
				alert('Error purging cache: ' + error.message);
			}
		}

		async function refreshVoiceModels() {
			try {
				const res = await authenticatedFetch('/api/models');
				if (!res) return;
				
				if (res.ok) {
					const models = await res.json();
					const container = document.getElementById('voiceModelsList');
					
					if (models.length === 0) {
						container.innerHTML = '<div class="text-slate-400">No voice models configured</div>';
						return;
					}
					
					container.innerHTML = models.map(model => `
						<div class="flex justify-between items-center bg-[#0b1020] p-3 rounded border border-slate-600">
							<div>
								<span class="font-medium">${model.name}</span>
								<span class="text-slate-400 text-sm ml-2">${model.id}</span>
							</div>
							<button onclick="deleteVoiceModel('${model.id}')" class="text-red-400 hover:text-red-300 transition-colors">
								Delete
							</button>
						</div>
					`).join('');
				}
			} catch (error) {
				document.getElementById('voiceModelsList').innerHTML = '<div class="text-red-400">Error loading voice models</div>';
			}
		}

		async function addVoiceModel() {
			const id = document.getElementById('newVoiceId').value.trim();
			const name = document.getElementById('newVoiceName').value.trim();
			
			if (!id || !name) {
				alert('Please enter both Voice ID and Name');
				return;
			}
			
			try {
				const res = await authenticatedFetch('/api/models', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ id, name })
				});
				
				if (!res) return;
				
				if (res.ok) {
					document.getElementById('newVoiceId').value = '';
					document.getElementById('newVoiceName').value = '';
					refreshVoiceModels();
					alert('Voice model added successfully');
				} else {
					const error = await res.json();
					alert('Failed to add voice model: ' + error.error);
				}
			} catch (error) {
				alert('Error adding voice model: ' + error.message);
			}
		}

		async function deleteVoiceModel(id) {
			if (!confirm('Are you sure you want to delete this voice model?')) {
				return;
			}
			
			try {
				const res = await authenticatedFetch(`/api/models/${id}`, {
					method: 'DELETE'
				});
				
				if (!res) return;
				
				if (res.ok) {
					refreshVoiceModels();
					alert('Voice model deleted successfully');
				} else {
					const error = await res.json();
					alert('Failed to delete voice model: ' + error.error);
				}
			} catch (error) {
				alert('Error deleting voice model: ' + error.message);
			}
		}

		async function refreshLogs() {
			try {
				const res = await authenticatedFetch('/api/logs');
				if (!res) return;
				
				if (res.ok) {
					const logs = await res.json();
					const container = document.getElementById('systemLogs');
					
					if (logs.length === 0) {
						container.innerHTML = '<div class="text-slate-400">No recent logs</div>';
						return;
					}
					
					container.innerHTML = logs.map(log => `
						<div class="bg-[#0b1020] p-2 rounded border border-slate-600">
							<div class="flex justify-between text-xs text-slate-400">
								<span>${new Date(log.timestamp).toLocaleString()}</span>
								<span>${log.user || 'system'}</span>
							</div>
							<div class="text-sm mt-1">${log.message}</div>
						</div>
					`).join('');
				}
			} catch (error) {
				document.getElementById('systemLogs').innerHTML = '<div class="text-red-400">Error loading logs</div>';
			}
		}
	</script>
</body>
</html>
