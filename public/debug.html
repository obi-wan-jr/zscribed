<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Generation Debug - DScribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .debug-step { transition: all 0.3s ease; }
        .debug-step:hover { background-color: #f3f4f6; }
        .status-success { color: #059669; }
        .status-error { color: #dc2626; }
        .status-warning { color: #d97706; }
        .status-info { color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Video Generation Debug</h1>
                <button onclick="refreshSessions()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Refresh
                </button>
            </div>

            <!-- Session List -->
            <div id="sessionList" class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Debug Sessions</h2>
                <div id="sessions" class="space-y-4">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>

            <!-- Session Details -->
            <div id="sessionDetails" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Session Details</h2>
                    <button onclick="hideSessionDetails()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="sessionInfo" class="bg-gray-100 p-4 rounded-lg mb-6">
                    <!-- Session info will be loaded here -->
                </div>

                <!-- Summary -->
                <div id="sessionSummary" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                    <!-- Summary cards will be loaded here -->
                </div>

                <!-- Steps -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Steps</h3>
                    <div id="sessionSteps" class="space-y-2">
                        <!-- Steps will be loaded here -->
                    </div>
                </div>

                <!-- Errors -->
                <div id="sessionErrors" class="mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-red-600">Errors</h3>
                    <div id="errors" class="space-y-2">
                        <!-- Errors will be loaded here -->
                    </div>
                </div>

                <!-- Warnings -->
                <div id="sessionWarnings" class="mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-yellow-600">Warnings</h3>
                    <div id="warnings" class="space-y-2">
                        <!-- Warnings will be loaded here -->
                    </div>
                </div>

                <!-- File Checks -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">File Checks</h3>
                    <div id="fileChecks" class="space-y-2">
                        <!-- File checks will be loaded here -->
                    </div>
                </div>

                <!-- FFmpeg Commands -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">FFmpeg Commands</h3>
                    <div id="ffmpegCommands" class="space-y-2">
                        <!-- FFmpeg commands will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentSession = null;

        async function loadSessions() {
            try {
                const response = await fetch('/api/debug/sessions');
                if (!response.ok) throw new Error('Failed to load sessions');
                
                const sessions = await response.json();
                displaySessions(sessions);
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessions').innerHTML = '<p class="text-red-600">Error loading sessions</p>';
            }
        }

        function displaySessions(sessions) {
            const container = document.getElementById('sessions');
            
            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No debug sessions found</p>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="debug-step border rounded-lg p-4 cursor-pointer" onclick="loadSessionDetails('${session.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${session.id}</h3>
                            <p class="text-sm text-gray-600">Job: ${session.jobId}</p>
                            <p class="text-sm text-gray-500">Started: ${new Date(session.startTime).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 rounded text-xs ${session.errors.length > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${session.errors.length > 0 ? 'Failed' : 'Success'}
                            </span>
                            <p class="text-sm text-gray-500 mt-1">${session.steps.length} steps</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadSessionDetails(sessionId) {
            try {
                const response = await fetch(`/api/debug/session/${sessionId}`);
                if (!response.ok) throw new Error('Failed to load session details');
                
                const session = await response.json();
                currentSession = session;
                displaySessionDetails(session);
            } catch (error) {
                console.error('Error loading session details:', error);
            }
        }

        function displaySessionDetails(session) {
            // Show session details section
            document.getElementById('sessionDetails').classList.remove('hidden');
            document.getElementById('sessionList').classList.add('hidden');

            // Session info
            document.getElementById('sessionInfo').innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <strong>Session ID:</strong><br>
                        <span class="text-sm">${session.sessionId}</span>
                    </div>
                    <div>
                        <strong>Job ID:</strong><br>
                        <span class="text-sm">${session.jobId}</span>
                    </div>
                    <div>
                        <strong>Duration:</strong><br>
                        <span class="text-sm">${(session.totalDuration / 1000).toFixed(2)}s</span>
                    </div>
                    <div>
                        <strong>Status:</strong><br>
                        <span class="text-sm ${session.summary.success ? 'status-success' : 'status-error'}">
                            ${session.summary.success ? 'Success' : 'Failed'}
                        </span>
                    </div>
                </div>
            `;

            // Summary
            document.getElementById('sessionSummary').innerHTML = `
                <div class="bg-green-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-green-800">${session.summary.totalSteps}</div>
                    <div class="text-sm text-green-600">Total Steps</div>
                </div>
                <div class="bg-red-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-red-800">${session.summary.totalErrors}</div>
                    <div class="text-sm text-red-600">Errors</div>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-800">${session.summary.totalWarnings}</div>
                    <div class="text-sm text-yellow-600">Warnings</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-blue-800">${session.summary.totalFileChecks}</div>
                    <div class="text-sm text-blue-600">File Checks</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-purple-800">${session.summary.totalFFmpegCommands}</div>
                    <div class="text-sm text-purple-600">FFmpeg Commands</div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <div class="text-2xl font-bold text-gray-800">${(session.totalDuration / 1000).toFixed(1)}s</div>
                    <div class="text-sm text-gray-600">Total Time</div>
                </div>
            `;

            // Steps
            document.getElementById('sessionSteps').innerHTML = session.steps.map(step => `
                <div class="debug-step border rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <strong>${step.step}</strong>
                            <p class="text-sm text-gray-600">${new Date(step.timestamp).toLocaleTimeString()}</p>
                        </div>
                        <span class="text-sm text-gray-500">${step.duration}ms</span>
                    </div>
                    ${step.details ? `<pre class="text-xs bg-gray-100 p-2 mt-2 rounded overflow-x-auto">${JSON.stringify(step.details, null, 2)}</pre>` : ''}
                </div>
            `).join('');

            // Errors
            if (session.errors.length > 0) {
                document.getElementById('sessionErrors').classList.remove('hidden');
                document.getElementById('errors').innerHTML = session.errors.map(error => `
                    <div class="debug-step border border-red-200 rounded-lg p-3 bg-red-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <strong class="text-red-800">${error.error}</strong>
                                <p class="text-sm text-gray-600">${new Date(error.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <span class="text-sm text-gray-500">${error.duration}ms</span>
                        </div>
                        ${error.stack ? `<pre class="text-xs bg-red-100 p-2 mt-2 rounded overflow-x-auto">${error.stack}</pre>` : ''}
                        ${error.context ? `<pre class="text-xs bg-gray-100 p-2 mt-2 rounded overflow-x-auto">${JSON.stringify(error.context, null, 2)}</pre>` : ''}
                    </div>
                `).join('');
            }

            // Warnings
            if (session.warnings.length > 0) {
                document.getElementById('sessionWarnings').classList.remove('hidden');
                document.getElementById('warnings').innerHTML = session.warnings.map(warning => `
                    <div class="debug-step border border-yellow-200 rounded-lg p-3 bg-yellow-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <strong class="text-yellow-800">${warning.warning}</strong>
                                <p class="text-sm text-gray-600">${new Date(warning.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <span class="text-sm text-gray-500">${warning.duration}ms</span>
                        </div>
                        ${warning.context ? `<pre class="text-xs bg-yellow-100 p-2 mt-2 rounded overflow-x-auto">${JSON.stringify(warning.context, null, 2)}</pre>` : ''}
                    </div>
                `).join('');
            }

            // File checks
            document.getElementById('fileChecks').innerHTML = session.fileChecks.map(check => `
                <div class="debug-step border rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>${check.filePath}</strong>
                            <p class="text-sm text-gray-600">${new Date(check.timestamp).toLocaleTimeString()}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 rounded text-xs ${check.status === 'PASS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${check.status}
                            </span>
                            <p class="text-sm text-gray-500 mt-1">${check.size} bytes</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // FFmpeg commands
            document.getElementById('ffmpegCommands').innerHTML = session.ffmpegCommands.map(cmd => `
                <div class="debug-step border rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <strong>FFmpeg Command</strong>
                            <p class="text-sm text-gray-600">${new Date(cmd.timestamp).toLocaleTimeString()}</p>
                            <pre class="text-xs bg-gray-100 p-2 mt-2 rounded overflow-x-auto">${cmd.command}</pre>
                        </div>
                        <div class="text-right ml-4">
                            <span class="px-2 py-1 rounded text-xs ${cmd.fileExists ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${cmd.fileExists ? 'File Created' : 'File Missing'}
                            </span>
                            <p class="text-sm text-gray-500 mt-1">${cmd.fileSize} bytes</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function hideSessionDetails() {
            document.getElementById('sessionDetails').classList.add('hidden');
            document.getElementById('sessionList').classList.remove('hidden');
            currentSession = null;
        }

        function refreshSessions() {
            loadSessions();
        }

        // Load sessions on page load
        loadSessions();

        // Auto-refresh every 30 seconds
        setInterval(loadSessions, 30000);
    </script>
</body>
</html>
